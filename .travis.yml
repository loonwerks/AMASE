sudo: false
dist: bionic
services:
- xvfb
language: java
jdk:
- openjdk8
cache:
  directories
  - $HOME/.m2

addons:
  apt:
    packages:
    - pandoc
    - python3
    - python3-pip

env:
  global:
  - DISPLAY=:99.0
  - secure: VQ0tByPJfWJQytLdGmysXHagddzDnXITWw4QUDKfR4NC/rF/NE9i+Vqc6jNu9IO233tPnlkqZUeBqwAlZ8ojsTJJRwY4/HXi/gqqHo2RKMOscLmUCtGkb+IvDtOrI6/I/9mdq5pjU19Jz7ztYKY4pLpvhwZJUOsksgQIv6sO94CiEDC2/yuwn23VJ32ZCRrtj1WEYv+lVONT+JjysqFO1tdh3dJZ834+Hmhp7jbC65oHoWDtgQTpl2pdpan89EFkESESicZ/ZWKZ4PatSVIOHGk55bg8JhucRAbjKCchnLytgqanLaVG3MdUEdySQ4xJ6smphtQwh45p3NZiiDTkyQ1Sp8ncbNhzOBAyM+2avGwHzrgPou8jm4eJGsVTjlvMY7gUAY6iKx0uaQtMJrvIrYj8eKHJZgjlJgIzC+QrShdBMB++jCWkjaeVtd/RHTP2OMT2H8Xw0qNEz6neGOhzH5pIgeaK7CucJ9fFDrhcWQ2eWHLG/krSRyfNv9ZP8YXcnKmfqi5OF9YHjPoT4kAu9kApDlapV8GXQcd5myA2dz6XWGmvlrJ3E8kIMGshPeU2cnMxajmAO0J28PgNxM0C1t8T+twoIHQ+Eh51ptQ314A9jDNXTquzxoekU6+Lzm3icMlym+gXoN7a4ddOdwe/xauk7hwqOR5j2vDtED3iQ24=

before_install:
- pip3 install --user --upgrade setuptools
- pip3 install --user boto3 GitPython github3.py mako pandocfilters
- "./git-setup.sh"

install: /bin/true

script:
- pushd safety_annex/plugins
- mvn clean verify
- popd

before_deploy:
- rm -rf s3-tools && git clone --depth 1 https://github.com/loonwerks/s3-tools.git
- export RELEASE_PKG_FILE=$(ls safety_annex/plugins/edu.umn.crisys.safety.repository/target/edu.umn.crisys.safety.repository-*.zip)
- echo "deploying $RELEASE_PKG_FILE to GitHub releases"
- export SNAPSHOT_NUMBER=$(ls safety_annex/plugins/edu.umn.crisys.safety.repository/target/repository/plugins/edu.umn.crisys.safety_*.jar
  | grep -o "[0-9]\\+\\.[0-9]\\+\\.[0-9]\\+\\.[0-9]\\{12\\}")
- echo "deploying snapshot number $SNAPSHOT_NUMBER"

deploy:
- provider: releases
  api-key: "$GH_TOKEN"
  file:
  - "${RELEASE_PKG_FILE}"
  name: Continuous Integration Build ($SNAPSHOT_NUMBER)
  body: Automated AGREE integration build of $TRAVIS_BRANCH ($TRAVIS_COMMIT) built
    by Travis CI on $(date +'%F %T %Z').
  prerelease: true
  overwrite: false
  skip_cleanup: true
  target_commitish: "$TRAVIS_COMMIT"
  on:
    branch: master
- provider: script
  script: python3 .travis/manage_daily_builds.py "Continuous Integration Build"
  on:
    branch: master
- provider: script
  script: python3 s3-tools/s3tools/DeployToP2CompositeRepository.py --path safety_annex/plugins/edu.umn.crisys.safety.repository/target/repository --prefix p2/snapshots/amase --child-name amase_$SNAPSHOT_NUMBER --logging DEBUG
  skip_cleanup: true
  on:
    branch: master
- provider: script
  script: python3 s3-tools/s3tools/ManageSnapshots.py --prefix p2/snapshots/amase --logging=DEBUG
  on:
    branch: master
